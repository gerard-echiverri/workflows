name: Manual Deploy SageMaker Endpoint

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: AWS region
        required: true
        default: ca-west-1
      endpoint_name:
        description: SageMaker endpoint name
        required: true
      model_name_prefix:
        description: Prefix for the model name (timestamp will be appended)
        required: true
        default: model
      model_version:
        description: Model version to deploy (appended to the model name)
        required: true
        default: latest
      endpoint_config_name_prefix:
        description: Prefix for the endpoint config name (timestamp will be appended)
        required: true
        default: endpoint-config
      execution_role_arn:
        description: SageMaker execution role ARN
        required: true
      container_image_uri:
        description: ECR image URI for inference container
        required: true
      model_data_s3_uri:
        description: S3 URI to model artifact (optional for certain containers)
        required: false
      instance_type:
        description: Instance type for production variant
        required: true
        default: ml.m5.large
      initial_instance_count:
        description: Initial instance count
        required: true
        default: "1"
      variant_name:
        description: Production variant name
        required: true
        default: AllTraffic

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve target environment
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          ROLE_ARN_DEV: ${{ secrets.AWS_ROLE_ARN_DEV }}
          ROLE_ARN_STAGE: ${{ secrets.AWS_ROLE_ARN_STAGE }}
          ROLE_ARN_TST: ${{ secrets.AWS_ROLE_ARN_TST }}
        run: |
          set -euo pipefail

          case "${BRANCH_NAME}" in
            dev)
              echo "TARGET_ENV=dev" >> "$GITHUB_ENV"
              echo "TARGET_ROLE_ARN=${ROLE_ARN_DEV}" >> "$GITHUB_ENV"
              ;;
            stage)
              echo "TARGET_ENV=stage" >> "$GITHUB_ENV"
              echo "TARGET_ROLE_ARN=${ROLE_ARN_STAGE}" >> "$GITHUB_ENV"
              ;;
            tst)
              echo "TARGET_ENV=tst" >> "$GITHUB_ENV"
              echo "TARGET_ROLE_ARN=${ROLE_ARN_TST}" >> "$GITHUB_ENV"
              ;;
            *)
              echo "Unsupported branch '${BRANCH_NAME}'. Use dev, stage, or tst." >&2
              exit 1
              ;;
          esac

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws_region }}
          role-to-assume: ${{ env.TARGET_ROLE_ARN }}

      - name: Deploy SageMaker endpoint
        env:
          AWS_REGION: ${{ inputs.aws_region }}
          ENDPOINT_NAME: ${{ inputs.endpoint_name }}
          MODEL_NAME_PREFIX: ${{ inputs.model_name_prefix }}
          MODEL_VERSION: ${{ inputs.model_version }}
          ENDPOINT_CONFIG_NAME_PREFIX: ${{ inputs.endpoint_config_name_prefix }}
          EXECUTION_ROLE_ARN: ${{ inputs.execution_role_arn }}
          CONTAINER_IMAGE_URI: ${{ inputs.container_image_uri }}
          MODEL_DATA_S3_URI: ${{ inputs.model_data_s3_uri }}
          INSTANCE_TYPE: ${{ inputs.instance_type }}
          INITIAL_INSTANCE_COUNT: ${{ inputs.initial_instance_count }}
          VARIANT_NAME: ${{ inputs.variant_name }}
        run: |
          set -euo pipefail

          timestamp=$(date +"%Y%m%d-%H%M%S")
          model_name="${MODEL_NAME_PREFIX}-v${MODEL_VERSION}-${timestamp}"
          endpoint_config_name="${ENDPOINT_CONFIG_NAME_PREFIX}-${timestamp}"

          echo "Creating model: ${model_name}"
          if [ -n "${MODEL_DATA_S3_URI:-}" ]; then
            aws sagemaker create-model \
              --model-name "${model_name}" \
              --primary-container Image="${CONTAINER_IMAGE_URI}",ModelDataUrl="${MODEL_DATA_S3_URI}" \
              --execution-role-arn "${EXECUTION_ROLE_ARN}" \
              --region "${AWS_REGION}"
          else
            aws sagemaker create-model \
              --model-name "${model_name}" \
              --primary-container Image="${CONTAINER_IMAGE_URI}" \
              --execution-role-arn "${EXECUTION_ROLE_ARN}" \
              --region "${AWS_REGION}"
          fi

          echo "Creating endpoint config: ${endpoint_config_name}"
          aws sagemaker create-endpoint-config \
            --endpoint-config-name "${endpoint_config_name}" \
            --production-variants VariantName="${VARIANT_NAME}",ModelName="${model_name}",InitialInstanceCount="${INITIAL_INSTANCE_COUNT}",InstanceType="${INSTANCE_TYPE}" \
            --region "${AWS_REGION}"

          if aws sagemaker describe-endpoint --endpoint-name "${ENDPOINT_NAME}" --region "${AWS_REGION}" >/dev/null 2>&1; then
            echo "Updating existing endpoint: ${ENDPOINT_NAME}"
            aws sagemaker update-endpoint \
              --endpoint-name "${ENDPOINT_NAME}" \
              --endpoint-config-name "${endpoint_config_name}" \
              --region "${AWS_REGION}"
          else
            echo "Creating endpoint: ${ENDPOINT_NAME}"
            aws sagemaker create-endpoint \
              --endpoint-name "${ENDPOINT_NAME}" \
              --endpoint-config-name "${endpoint_config_name}" \
              --region "${AWS_REGION}"
          fi

          echo "Waiting for endpoint to be InService"
          aws sagemaker wait endpoint-in-service \
            --endpoint-name "${ENDPOINT_NAME}" \
            --region "${AWS_REGION}"

          echo "Deployment complete."
