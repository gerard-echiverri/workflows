name: Manual Deploy SageMaker Endpoint

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to deploy to
        required: true
        default: dev
      aws_region:
        description: AWS region
        required: true
        default: ca-central-1
      endpoint_name:
        description: SageMaker endpoint name
        required: true
        default: qc-ai-inference-ep
      model_package_group:
        description: Model package group to deploy
        required: true
        default: PLMSCWInferenceModelGroup-202601291627
      model_version:
        description: Model version to deploy (appended to the model name)
        required: true
        default: latest
      ecr_name:
        description: ECR name for inference container
        required: true
        default: plmscw-inference-data-dev
      instance_type:
        description: Instance type for production variant
        required: true
        default: ml.m5.large
      initial_instance_count:
        description: Initial instance count
        required: true
        default: "1"
      variant_name:
        description: Production variant name
        required: true
        default: AllTraffic
#./phsa-plms-apdigital-health-authorities/bc-cw
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-skip-session-tagging: true
          aws-region: ${{ inputs.aws_region }}
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          role-duration-seconds: 1800
          role-session-name: ci-deployment

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          # Install with no cache to save disk space
          pip install --no-cache-dir -r requirements.txt
        working-directory: phsa-plms-apdigital-health-authorities/bc-cw/services/ai-modules

      - name: Deploy SageMaker endpoint
        working-directory: phsa-plms-apdigital-health-authorities/bc-cw/services/ai-modules/deploy_model
        env:
          AWS_REGION: ${{ inputs.aws_region }}
          ENDPOINT_NAME: ${{ inputs.endpoint_name }}
          MODEL_PACKAGE_GROUP: ${{ inputs.model_package_group }}
          MODEL_VERSION: ${{ inputs.model_version }}
          CONTAINER_IMAGE_URI: ${{ inputs.ecr_name }}
          INSTANCE_TYPE: ${{ inputs.instance_type }}
          INITIAL_INSTANCE_COUNT: ${{ inputs.initial_instance_count }}
          VARIANT_NAME: ${{ inputs.variant_name }}
          SAGEMAKER_EXECUTION_ROLE_ARN: ${{ secrets.SAGEMAKER_EXECUTION_ROLE_ARN }}
        run: |
          pwd
          
          python deploy-model.py -g "$MODEL_PACKAGE_GROUP" --endpoint-name "$ENDPOINT_NAME" -t "$INSTANCE_TYPE" -g PLMSCWInferenceModelGroup-202601291627
