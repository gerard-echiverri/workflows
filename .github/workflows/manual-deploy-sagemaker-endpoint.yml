name: Manual Deploy SageMaker Endpoint

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to deploy to
        required: true
        default: dev
      aws_region:
        description: AWS region
        required: true
        default: ca-central-1
      endpoint_name:
        description: SageMaker endpoint name
        required: true
        default: qc-ai-inference-ep
      model_name_prefix:
        description: Prefix for the model name (timestamp will be appended)
        required: true
        default: model
      model_version:
        description: Model version to deploy (appended to the model name)
        required: true
        default: latest
      endpoint_config_name_prefix:
        description: Prefix for the endpoint config name (timestamp will be appended)
        required: true
        default: endpoint-config
      ecr_name:
        description: ECR name for inference container
        required: true
        default: plmscw-inference-data-dev
      instance_type:
        description: Instance type for production variant
        required: true
        default: ml.m5.large
      initial_instance_count:
        description: Initial instance count
        required: true
        default: "1"
      variant_name:
        description: Production variant name
        required: true
        default: AllTraffic
#./phsa-plms-apdigital-health-authorities/bc-cw
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-skip-session-tagging: true
          aws-region: ${{ inputs.aws_region }}
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          role-duration-seconds: 1800
          role-session-name: ci-deployment

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install sagemaker

      - name: Deploy SageMaker endpoint
        working-directory: ./phsa-plms-apdigital-health-authorities/bc-cw/services/ai-modules/deploy_model
        env:
          AWS_REGION: ${{ inputs.aws_region }}
          AWS_ACCOUNT: ${{ vars.AWS_ACCOUNT }}
          ENDPOINT_NAME: ${{ inputs.endpoint_name }}
          MODEL_NAME_PREFIX: ${{ inputs.model_name_prefix }}
          MODEL_VERSION: ${{ inputs.model_version }}
          ENDPOINT_CONFIG_NAME_PREFIX: ${{ inputs.endpoint_config_name_prefix }}
          CONTAINER_IMAGE_URI: ${{ inputs.ecr_name }}
          INSTANCE_TYPE: ${{ inputs.instance_type }}
          INITIAL_INSTANCE_COUNT: ${{ inputs.initial_instance_count }}
          VARIANT_NAME: ${{ inputs.variant_name }}
          SAGEMAKER_EXECUTION_ROLE_ARN: ${{ secrets.SAGEMAKER_EXECUTION_ROLE_ARN }}
        run: |
          pwd
          
          python deploy-model.py -g --aws-account "$AWS_ACCOUNT" --endpoint-name "$ENDPOINT_NAME" -t "$INSTANCE_TYPE"
