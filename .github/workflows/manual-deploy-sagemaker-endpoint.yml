name: Manual Deploy SageMaker Endpoint

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to deploy to
        required: true
        default: dev
      aws_region:
        description: AWS region
        required: true
        default: ca-west-1
      endpoint_name:
        description: SageMaker endpoint name
        required: true
        default: qc-ai-inference-ep
      model_name_prefix:
        description: Prefix for the model name (timestamp will be appended)
        required: true
        default: model
      model_version:
        description: Model version to deploy (appended to the model name)
        required: true
        default: latest
      endpoint_config_name_prefix:
        description: Prefix for the endpoint config name (timestamp will be appended)
        required: true
        default: endpoint-config
      ecr_name:
        description: ECR name for inference container
        required: true
        default: plmscw-inference-data-dev
      instance_type:
        description: Instance type for production variant
        required: true
        default: ml.m5.large
      initial_instance_count:
        description: Initial instance count
        required: true
        default: "1"
      variant_name:
        description: Production variant name
        required: true
        default: AllTraffic
#./phsa-plms-apdigital-health-authorities/bc-cw
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws_region }}
          role-to-assume: ${{ secrets.SAGEMAKER_EXECUTION_ROLE_ARN }}

      - name: Deploy SageMaker endpoint
        env:
          AWS_REGION: ${{ inputs.aws_region }}
          ENDPOINT_NAME: ${{ inputs.endpoint_name }}
          MODEL_NAME_PREFIX: ${{ inputs.model_name_prefix }}
          MODEL_VERSION: ${{ inputs.model_version }}
          ENDPOINT_CONFIG_NAME_PREFIX: ${{ inputs.endpoint_config_name_prefix }}
          CONTAINER_IMAGE_URI: ${{ inputs.container_image_uri }}
          MODEL_DATA_S3_URI: ${{ inputs.model_data_s3_uri }}
          INSTANCE_TYPE: ${{ inputs.instance_type }}
          INITIAL_INSTANCE_COUNT: ${{ inputs.initial_instance_count }}
          VARIANT_NAME: ${{ inputs.variant_name }}
        run: |
          set -euo pipefail

          timestamp=$(date +"%Y%m%d-%H%M%S")
          model_name="${MODEL_NAME_PREFIX}-v${MODEL_VERSION}-${timestamp}"
          endpoint_config_name="${ENDPOINT_CONFIG_NAME_PREFIX}-${timestamp}"

          echo "Creating model: ${model_name}"
          
          echo "Deployment complete."
